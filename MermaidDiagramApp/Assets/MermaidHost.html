<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Preview</title>
    <style>
        body {
            background-color: #222;
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        #mermaid-container {
            width: 100%;
            max-width: 100%;
            overflow: auto;
            text-align: center;
        }
        #debug-info {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow: auto;
            display: none;
        }
        .error {
            color: #ff6b6b;
            white-space: pre-wrap;
            padding: 20px;
            max-width: 100%;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div id="mermaid-container" class="mermaid">
        <div id="loading-placeholder">Loading Mermaid.js...</div>
    </div>
    <div id="debug-info"></div>
    
    <!-- Load Mermaid.js from CDN with fallback -->
    <script>
        window.log = function() {
            const args = Array.from(arguments);
            console.log(...args);
            
            // Send logs back to the host app
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                ).join(' '));
            }
            
            // Show in debug panel
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                const line = document.createElement('div');
                line.textContent = args.join(' ');
                debugInfo.appendChild(line);
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        };
        
        // Toggle debug panel with Ctrl+Shift+D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                }
            }
        });
        
        log('Starting Mermaid initialization...');
       
        // Load Mermaid.js with fallback
        function loadMermaid() {
            return new Promise((resolve, reject) => {
                // Try loading from local virtual host first
                const localScript = document.createElement('script');
                localScript.src = 'mermaid.min.js';
               
                localScript.onload = () => {
                    log('Mermaid.js loaded from local virtual host');
                    resolve();
                };
               
                localScript.onerror = () => {
                    log('Failed to load Mermaid.js from local virtual host, trying CDN...');

                    const cdnScript = document.createElement('script');
                    cdnScript.src = 'https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js';
                    cdnScript.onload = () => {
                        log('Mermaid.js loaded from CDN');
                        resolve();
                    };
                    cdnScript.onerror = () => {
                        const error = 'Failed to load Mermaid.js from both local mapping and CDN';
                        log(error);
                        reject(new Error(error));
                    };
                    document.head.appendChild(cdnScript);
                };

                document.head.appendChild(localScript);
            });
        }
        
        // Initialize the application
        async function getMermaidVersion() {
            try {
                if (mermaid.mermaidAPI?.getDiagramFromText) {
                    const infoDiagram = await mermaid.mermaidAPI.getDiagramFromText('info');
                    const versionFromInfo = infoDiagram?.db?.getVersion?.();
                    if (versionFromInfo) {
                        return versionFromInfo;
                    }
                }

                if (mermaid.version) {
                    return mermaid.version;
                }

                if (mermaid.mermaidAPI?.version) {
                    return mermaid.mermaidAPI.version;
                }
            } catch (error) {
                log('Failed to determine Mermaid version from runtime:', error);
            }

            return 'unknown';
        }

        async function init() {
            try {
                await loadMermaid();

                if (typeof mermaid === 'undefined') {
                    throw new Error('Mermaid is not defined after loading');
                }

                const runtimeVersion = await getMermaidVersion();

                window.detectedMermaidVersion = runtimeVersion;
                log('Mermaid version (runtime):', runtimeVersion);
                
                window.mermaid.initialize({
                    startOnLoad: false,
                    securityLevel: 'loose',
                    theme: 'dark',
                    logLevel: 1 // Debug level logging
                });
                
                log('Mermaid initialized successfully');

                // Notify host that we're ready
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage('MermaidReady');
                }

                // Show default prompt in the container
                const container = document.getElementById('mermaid-container');
                if (container) {
                    container.innerHTML = '<div style="color:#888;">Enter Mermaid code to see the diagram</div>';
                }
            } catch (error) {
                const errorMsg = `Failed to initialize Mermaid: ${error.message || error}`;
                log(errorMsg);
                document.getElementById('mermaid-container').innerHTML = 
                    `<div class="error">${errorMsg}\n\n${error.stack || ''}</div>`;
            }
        }
        
        // Global functions that can be called from C#
        window.renderDiagram = async function(code) {
            const container = document.getElementById('mermaid-container');
            window.currentSvg = '';
            
            if (!code || !code.trim()) {
                log('No code provided to render');
                container.innerHTML = '<div style="color:#888;">Enter Mermaid code to see the diagram</div>';
                return;
            }
            
            log('Rendering diagram...');
            container.innerHTML = '<div>Rendering diagram...</div>';
            
            try {
                const { svg } = await mermaid.render('mermaid-diagram', code);
                container.innerHTML = svg;
                window.currentSvg = svg;
                log('Diagram rendered successfully');
            } catch (error) {
                const errorMsg = `Rendering failed: ${error.message || error}`;
                log(errorMsg);
                container.innerHTML = 
                    `<div class="error">${errorMsg}\n\n${error.stack || ''}</div>`;
            }
        };
        
        window.getSvg = function() {
            return window.currentSvg || '';
        };
        
        // Start initialization
        init();
    </script>
</body>
</html>
