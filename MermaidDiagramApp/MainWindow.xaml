<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="MermaidDiagramApp.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MermaidDiagramApp"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:tcb="using:TextControlBoxNS"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:ctk="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:converters="using:MermaidDiagramApp.Converters"
    xmlns:models="using:MermaidDiagramApp.Models"
    xmlns:viewmodels="using:MermaidDiagramApp.ViewModels"
    xmlns:views="using:MermaidDiagramApp.Views"
    mc:Ignorable="d"
    Title="MermaidDiagramApp">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid RowDefinitions="Auto, Auto, Auto, *, Auto" KeyDown="MainWindow_KeyDown" PreviewKeyDown="MainWindow_PreviewKeyDown">
        <ContentDialog x:Name="PngExportDialog"
                       Title="Export PNG Options"
                       PrimaryButtonText="Export"
                       CloseButtonText="Cancel"
                       DefaultButton="Primary"
                       MinWidth="320">
            <StackPanel Spacing="12">
                <TextBlock Text="Set the export scale. A higher value increases the image resolution." TextWrapping="Wrap"/>
                <NumberBox x:Name="ScaleNumberBox"
                           Header="Scale"
                           Value="2"
                           Minimum="0.5"
                           Maximum="10"
                           SpinButtonPlacementMode="Compact"
                           SmallChange="0.5"/>
            </StackPanel>
        </ContentDialog>

        <ContentDialog x:Name="RestartDialog"
                       Title="Update Complete"
                       Content="Mermaid.js has been updated. Do you want to restart the application now for the changes to take effect?"
                       PrimaryButtonText="Restart Now"
                       CloseButtonText="Later"
                       DefaultButton="Primary">
        </ContentDialog>

        <ContentDialog x:Name="AboutDialog"
                       Title="About Mermaid Diagram App"
                       CloseButtonText="OK"
                       DefaultButton="Close">
            <StackPanel Spacing="12">
                <TextBlock x:Name="VersionTextBlock"/>
                <TextBlock x:Name="InstallDateTextBlock"/>
                <TextBlock x:Name="MermaidVersionTextBlock"/>
                <TextBlock x:Name="MarkdownVersionTextBlock"/>
            </StackPanel>
        </ContentDialog>

        <ContentDialog x:Name="ExportProgressDialog"
                       Title="Exporting to Word"
                       CloseButtonText="Cancel"
                       DefaultButton="Close">
            <StackPanel Spacing="12">
                <TextBlock x:Name="ExportProgressMessage" Text="Preparing export..." TextWrapping="Wrap"/>
                <ProgressBar x:Name="ExportProgressBar" 
                             Minimum="0" 
                             Maximum="100" 
                             Value="0"
                             IsIndeterminate="False"/>
                <TextBlock x:Name="ExportProgressPercentage" Text="0%" HorizontalAlignment="Center"/>
            </StackPanel>
        </ContentDialog>

        <InfoBar x:Name="UpdateInfoBar" Grid.Row="0" IsOpen="False" Severity="Informational" Margin="12,12,12,0">
            <InfoBar.ActionButton>
                <Button Content="Update" Click="UpdateMermaid_Click"/>
            </InfoBar.ActionButton>
        </InfoBar>

        <InfoBar x:Name="LinterInfoBar" Grid.Row="1" IsOpen="False" Severity="Warning" Margin="12,0,12,0">
            <!-- Action button is set dynamically from code-behind -->
        </InfoBar>

        <InfoBar x:Name="KeyboardShortcutTipBar" Grid.Row="1" IsOpen="False" Severity="Informational" Margin="12,0,12,0" Title="Keyboard Shortcut Tip">
            <InfoBar.ActionButton>
                <Button Content="Don't show again" Click="DismissKeyboardTip_Click"/>
            </InfoBar.ActionButton>
        </InfoBar>

        <MenuBar x:Name="MainMenuBar" Grid.Row="2">
            <MenuBarItem Title="File">
                <MenuFlyoutSubItem Text="New">
                    <MenuFlyoutItem Text="Class Diagram" Click="NewClassDiagram_Click"/>
                    <MenuFlyoutItem Text="Sequence Diagram" Click="NewSequenceDiagram_Click"/>
                    <MenuFlyoutItem Text="State Diagram" Click="NewStateDiagram_Click"/>
                    <MenuFlyoutItem Text="Activity Diagram" Click="NewActivityDiagram_Click"/>
                    <MenuFlyoutSeparator/>
                    <MenuFlyoutItem Text="Flowchart" Click="NewFlowchart_Click"/>
                    <MenuFlyoutItem Text="Gantt Chart" Click="NewGanttChart_Click"/>
                    <MenuFlyoutItem Text="Pie Chart" Click="NewPieChart_Click"/>
                    <MenuFlyoutItem Text="Git Graph" Click="NewGitGraph_Click"/>
                </MenuFlyoutSubItem>
                <MenuFlyoutItem Text="Open" Click="Open_Click"/>
                <MenuFlyoutItem Text="Open Markdown File" Click="OpenMarkdownFile_Click"/>
                <MenuFlyoutItem Text="Close" Click="Close_Click"/>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Save" Click="Save_Click"/>
                <MenuFlyoutSubItem Text="Export">
                    <MenuFlyoutItem Text="as SVG" Click="ExportSvg_Click"/>
                    <MenuFlyoutItem Text="as PNG" Click="ExportPng_Click"/>
                    <MenuFlyoutItem x:Name="ExportToWordMenuItem" Text="to Word" Click="ExportToWord_Click" IsEnabled="False"/>
                </MenuFlyoutSubItem>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Exit" Click="Exit_Click"/>
            </MenuBarItem>
            <MenuBarItem Title="Edit">
                <MenuFlyoutItem Text="Check &amp; Fix Mermaid Syntax" Click="CheckSyntax_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F7"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
            </MenuBarItem>
            <MenuBarItem Title="View">
                <ToggleMenuFlyoutItem x:Name="BuilderTool" Text="Diagram Builder" Click="BuilderTool_Click"/>
                <ToggleMenuFlyoutItem x:Name="AiPanelTool" Text="AI Diagram Generator" Click="AiPanelTool_Click"/>
                <MenuFlyoutItem Text="Full Screen Preview (F11 or Ctrl+F11)" Click="ToggleFullScreen_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F11"/>
                        <KeyboardAccelerator Key="F11" Modifiers="Control"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutItem Text="Presentation Mode" Click="PresentationMode_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F5"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Markdown Style Settings..." Click="MarkdownStyleSettings_Click"/>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="Refresh Preview" Click="RefreshPreview_Click">
                    <MenuFlyoutItem.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F5" Modifiers="Control"/>
                    </MenuFlyoutItem.KeyboardAccelerators>
                </MenuFlyoutItem>
            </MenuBarItem>
            <MenuBarItem Title="Help">
                <MenuFlyoutItem Text="AI Settings" Click="AiSettings_Click"/>
                <MenuFlyoutItem Text="About" Click="About_Click"/>
                <MenuFlyoutSubItem Text="Diagnostics">
                    <MenuFlyoutItem Text="Open Log File" Click="OpenLogFile_Click"/>
                    <MenuFlyoutItem Text="Open Log Folder" Click="OpenLogFolder_Click"/>
                </MenuFlyoutSubItem>
            </MenuBarItem>
        </MenuBar>

        <Grid Grid.Row="3" Padding="12" x:Name="MainGrid">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="ToolboxColumn" Width="Auto" MinWidth="0" MaxWidth="400"/>
                <ColumnDefinition x:Name="ToolboxSplitterColumn" Width="Auto"/>
                <ColumnDefinition x:Name="BuilderColumn" Width="Auto" MinWidth="0"/>
                <ColumnDefinition x:Name="BuilderSplitterColumn" Width="Auto"/>
                <ColumnDefinition x:Name="EditorColumn" Width="*"/>
                <ColumnDefinition x:Name="EditorPreviewSplitterColumn" Width="Auto"/>
                <ColumnDefinition x:Name="PreviewColumn" Width="*"/>
                <ColumnDefinition x:Name="PropertiesSplitterColumn" Width="Auto"/>
                <ColumnDefinition x:Name="PropertiesColumn" Width="Auto" MinWidth="0" MaxWidth="400"/>
            </Grid.ColumnDefinitions>

            <!-- Removed old left AI panel; floating prompt is used instead -->

            <!-- Shape Toolbox (New Visual Builder) -->
            <Border x:Name="ToolboxPanel" Grid.Column="0" Visibility="Collapsed">
                <views:ShapeToolbox x:Name="ShapeToolboxControl"/>
            </Border>

            <ctk:GridSplitter x:Name="ToolboxSplitter"
                              Grid.Column="1"
                              Width="12"
                              Visibility="Collapsed"
                              ResizeBehavior="BasedOnAlignment"
                              ResizeDirection="Auto"
                              Background="Transparent"/>

            <!-- Visual Canvas (New Visual Builder) -->
            <Border x:Name="CanvasPanel" Grid.Column="2" Visibility="Collapsed">
                <views:DiagramCanvas x:Name="DiagramCanvasControl"/>
            </Border>

            <ctk:GridSplitter x:Name="CanvasSplitter"
                              Grid.Column="3"
                              Width="12"
                              Visibility="Collapsed"
                              ResizeBehavior="BasedOnAlignment"
                              ResizeDirection="Auto"
                              Background="Transparent"/>

            <!-- Old Builder Panel (Legacy) -->
            <Border x:Name="BuilderPanel" Grid.Column="2" Background="{ThemeResource ApplicationPageBackgroundThemeBrush}" Padding="12" Visibility="Collapsed">
                <Grid RowDefinitions="Auto, Auto, *, Auto, Auto, *, Auto">
                    <TextBlock Grid.Row="0" Text="Diagram Builder" Style="{ThemeResource TitleTextBlockStyle}" Margin="0,0,0,12"/>

                    <TextBlock Grid.Row="1" Text="Nodes" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                    <ListView Grid.Row="2" ItemsSource="{Binding Nodes}" SelectedItem="{Binding SelectedNode, Mode=TwoWay}">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:FlowchartNode">
                                <TextBlock Text="{Binding Text}"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <StackPanel Grid.Row="3" Spacing="8" Margin="0,12,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Add Node" Command="{Binding AddNodeCommand}"/>
                            <Button Content="Remove Node" Command="{Binding RemoveNodeCommand}"/>
                        </StackPanel>
                        
                        <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto, Auto" RowSpacing="8" ColumnSpacing="8" 
                              Visibility="{Binding SelectedNode, Converter={StaticResource NullToVisibilityConverter}}">
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="ID" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedNode.Id, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Text" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SelectedNode.Text, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Shape" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="2" Grid.Column="1" ItemsSource="{x:Bind models:FlowchartNode.GetShapeNames()}" 
                                      SelectedItem="{Binding SelectedNode.Shape, Mode=TwoWay, Converter={StaticResource EnumToStringConverter}}"/>
                        </Grid>
                    </StackPanel>
                    
                    <TextBlock Grid.Row="4" Text="Edges" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,24,0,0"/>
                    <ListView Grid.Row="5" ItemsSource="{Binding Edges}" SelectedItem="{Binding SelectedEdge, Mode=TwoWay}">
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:FlowchartEdge">
                                <TextBlock Text="{Binding Label}"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <StackPanel Grid.Row="6" Spacing="8" Margin="0,12,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Add Edge" Command="{Binding AddEdgeCommand}"/>
                            <Button Content="Remove Edge" Command="{Binding RemoveEdgeCommand}"/>
                        </StackPanel>

                        <Grid ColumnDefinitions="Auto, *" RowDefinitions="Auto, Auto, Auto, Auto" RowSpacing="8" ColumnSpacing="8"
                              Visibility="{Binding SelectedEdge, Converter={StaticResource NullToVisibilityConverter}}">
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="From" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="0" Grid.Column="1" ItemsSource="{Binding Nodes}" SelectedValue="{Binding SelectedEdge.StartNodeId, Mode=TwoWay}" SelectedValuePath="Id" DisplayMemberPath="Id"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="To" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="1" Grid.Column="1" ItemsSource="{Binding Nodes}" SelectedValue="{Binding SelectedEdge.EndNodeId, Mode=TwoWay}" SelectedValuePath="Id" DisplayMemberPath="Id"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Text" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding SelectedEdge.Text, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Arrow" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="3" Grid.Column="1" ItemsSource="{x:Bind models:FlowchartEdge.GetArrowTypeNames()}" 
                                      SelectedItem="{Binding SelectedEdge.ArrowType, Mode=TwoWay, Converter={StaticResource EnumToStringConverter}}"/>
                        </Grid>
                    </StackPanel>
                </Grid>
            </Border>

            <Grid Grid.Column="4">
                <tcb:TextControlBox
                    x:Name="CodeEditor"
                    ShowLineNumbers="True"/>

                <!-- Floating AI Prompt moved to OverlayCanvas at root level -->
            </Grid>

            <ctk:GridSplitter x:Name="EditorPreviewSplitter"
                                   Grid.Column="5"
                                   Width="12"
                                   ResizeBehavior="BasedOnAlignment"
                                   ResizeDirection="Auto"
                                   Background="Transparent"/>

            <Grid Grid.Column="6">
                <WebView2 x:Name="PreviewBrowser"/>
                
                <!-- Refresh Button (always visible) -->
                <Button x:Name="FloatingRefreshButton"
                        Content="⟳"
                        Width="40"
                        Height="40"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Margin="16,80,16,16"
                        Background="#CC000000"
                        Foreground="White"
                        FontSize="20"
                        CornerRadius="20"
                        BorderThickness="0"
                        ToolTipService.ToolTip="Refresh Preview"
                        Click="RefreshPreview_Click">
                    <Button.Shadow>
                        <ThemeShadow />
                    </Button.Shadow>
                </Button>
                
                <!-- Zoom Controls (visible in full-screen mode) -->
                <StackPanel x:Name="ZoomControlsPanel"
                            Orientation="Vertical"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Bottom"
                            Margin="20"
                            Spacing="12"
                            Visibility="Collapsed">
                    <!-- Refresh Button in Zoom Panel -->
                    <Button Width="48"
                            Height="48"
                            Background="#CC000000"
                            Foreground="White"
                            CornerRadius="24"
                            BorderThickness="0"
                            Padding="0"
                            ToolTipService.ToolTip="Refresh Preview"
                            Click="RefreshPreview_Click">
                        <Button.Shadow>
                            <ThemeShadow />
                        </Button.Shadow>
                        <TextBlock Text="⟳"
                                   FontSize="22"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   TextAlignment="Center"
                                   Margin="0,-2,0,0"/>
                    </Button>
                    
                    <!-- Zoom In -->
                    <Button x:Name="ZoomInButton"
                            Width="48"
                            Height="48"
                            Background="#CC000000"
                            Foreground="White"
                            CornerRadius="24"
                            BorderThickness="0"
                            Padding="0"
                            ToolTipService.ToolTip="Zoom In"
                            Click="ZoomIn_Click">
                        <Button.Shadow>
                            <ThemeShadow />
                        </Button.Shadow>
                        <TextBlock Text="+"
                                   FontSize="28"
                                   FontWeight="Normal"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   TextAlignment="Center"
                                   Margin="0,-3,0,0"/>
                    </Button>
                    
                    <!-- Zoom Level Display -->
                    <Border Background="#CC000000"
                            CornerRadius="24"
                            Padding="12,10"
                            BorderThickness="0">
                        <Border.Shadow>
                            <ThemeShadow />
                        </Border.Shadow>
                        <TextBlock x:Name="ZoomLevelText"
                                   Text="100%"
                                   Foreground="White"
                                   FontSize="15"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Center"
                                   MinWidth="55"
                                   TextAlignment="Center"/>
                    </Border>
                    
                    <!-- Zoom Out -->
                    <Button x:Name="ZoomOutButton"
                            Content="−"
                            Width="48"
                            Height="48"
                            Background="#CC000000"
                            Foreground="White"
                            FontSize="28"
                            FontWeight="Normal"
                            CornerRadius="24"
                            BorderThickness="0"
                            Padding="0"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            ToolTipService.ToolTip="Zoom Out"
                            Click="ZoomOut_Click">
                        <Button.Shadow>
                            <ThemeShadow />
                        </Button.Shadow>
                    </Button>
                    
                    <!-- Reset Zoom -->
                    <Button x:Name="ZoomResetButton"
                            Content="⊙"
                            Width="48"
                            Height="48"
                            Background="#CC000000"
                            Foreground="White"
                            FontSize="22"
                            CornerRadius="24"
                            BorderThickness="0"
                            Padding="0"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            ToolTipService.ToolTip="Reset Zoom (100%)"
                            Click="ZoomReset_Click">
                        <Button.Shadow>
                            <ThemeShadow />
                        </Button.Shadow>
                    </Button>
                    
                    <!-- Separator -->
                    <Border Height="2" 
                            Background="#44FFFFFF" 
                            Margin="8,4"/>
                    
                    <!-- Drag/Select Mode Toggle -->
                    <ToggleButton x:Name="DragModeToggle"
                                  Width="48"
                                  Height="48"
                                  Background="#CC000000"
                                  Foreground="White"
                                  CornerRadius="24"
                                  BorderThickness="0"
                                  Padding="0"
                                  HorizontalContentAlignment="Center"
                                  VerticalContentAlignment="Center"
                                  ToolTipService.ToolTip="Toggle Drag/Select Mode"
                                  Click="DragModeToggle_Click">
                        <ToggleButton.Shadow>
                            <ThemeShadow />
                        </ToggleButton.Shadow>
                        <FontIcon x:Name="DragModeIcon" 
                                  Glyph="&#xE7C2;" 
                                  FontSize="20"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center"/>
                    </ToggleButton>
                </StackPanel>
            </Grid>

            <!-- Properties Panel (New Visual Builder) -->
            <ctk:GridSplitter x:Name="PropertiesSplitter"
                              Grid.Column="7"
                              Width="12"
                              Visibility="Collapsed"
                              ResizeBehavior="BasedOnAlignment"
                              ResizeDirection="Auto"
                              Background="Transparent"/>

            <Border x:Name="PropertiesPanel" Grid.Column="8" Visibility="Collapsed">
                <views:PropertiesPanel x:Name="PropertiesPanelControl"/>
            </Border>
            <!-- Overlay for floating panels (topmost within editor area) -->
            <Canvas x:Name="OverlayCanvas"
                    Grid.Column="4"
                    Grid.ColumnSpan="3"
                    Canvas.ZIndex="1000"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    IsHitTestVisible="True">
                <views:FloatingAiPrompt x:Name="FloatingAiPromptControl"
                                         Canvas.Left="24"
                                         Canvas.Top="24"
                                         Visibility="Collapsed"/>
            </Canvas>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="4" 
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,6">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <FontIcon x:Name="RenderModeIcon" 
                              Glyph="&#xE8A5;" 
                              FontSize="14"
                              Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"/>
                    <TextBlock x:Name="RenderModeText" 
                               Text="Mermaid Diagram"
                               FontSize="12"
                               VerticalAlignment="Center"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" 
                            Orientation="Horizontal" 
                            Spacing="12">
                    <Button x:Name="RenderModeOverrideButton"
                            Content="Rendering Mode"
                            FontSize="12"
                            Padding="8,4"
                            Click="RenderModeOverride_Click"
                            ToolTipService.ToolTip="Override automatic content type detection">
                        <Button.Flyout>
                            <MenuFlyout x:Name="RenderModeFlyout">
                                <RadioMenuFlyoutItem x:Name="AutoDetectMode" 
                                                     Text="Auto-detect" 
                                                     IsChecked="True"
                                                     Click="AutoDetectMode_Click"/>
                                <RadioMenuFlyoutItem x:Name="ForceMermaidMode" 
                                                     Text="Force Mermaid" 
                                                     Click="ForceMermaidMode_Click"/>
                                <RadioMenuFlyoutItem x:Name="ForceMarkdownMode" 
                                                     Text="Force Markdown" 
                                                     Click="ForceMarkdownMode_Click"/>
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
